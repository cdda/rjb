<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge' http-equiv='X-UA-Compatible'>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <title>CDDA Raw JSON Browser</title>
    <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css' rel='stylesheet'>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css'>
    <link rel='stylesheet' href='/tablesorter.css'>
    <script src='https://code.jquery.com/jquery-2.1.3.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.1/handlebars.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.21.4/js/jquery.tablesorter.js'></script>
    <style>
body {
  padding-top: 64px;
}
.footer {
  font-size: 80%;
  border-top: 1px solid #d0d0d0;
  padding: 0.2em;
}
.types {
  background-color: #d5d5d5;
  margin-left: 0.2em;
}
.panel-btn {
  margin-right: 0.5em;
  cursor: pointer;
}
.panel-btn:hover {
  text-decoration: none;
  color: red;
}
    </style>
    <script id='t-search' type='text/x-handlebars-template'>
{{#if data}}
<div id='panel{{uid}}' class='panel panel-success'>
{{else}}
<div id='panel{{uid}}' class='panel panel-warning'>
{{/if}}
<div class='panel-heading'>
<h3 class='panel-title'>
<a class='panel-btn' onclick='closePanel({{uid}})'>
<span class='glyphicon glyphicon-remove' aria-hidden='true'></span>
</a>
<a class='panel-btn' href='#search:{{query}}'>
<span class='glyphicon glyphicon-link' aria-hidden='true'></span>
</a>
Search results for "<b>{{query}}</b>"
</h3>
</div>
<div class='panel-body'>
{{#if data}}
<table id='table{{uid}}' class='table table-striped'>
<thead>
<tr>
<th>ID</th>
<th>Type</th>
</tr>
</thead>
<tbody>
{{#each data}}
<tr>
<td>{{id}}</td>
<td>
{{#each types}}
<a onclick="show('{{this}}', '{{../id}}')">{{this}}</a>
{{/each}}
</td>
</tr>
{{/each}}
</tbody>
</table>
{{else}}
<h4>Sorry, nothing found.</h4>
{{/if}}
</div>
</div>
    </script>
    <script id='t-show' type='text/x-handlebars-template'>
<div id='panel{{uid}}' class='panel panel-primary'>
<div class='panel-heading'>
<h3 class='panel-title'>
<a class='panel-btn' onclick='closePanel({{uid}})'>
<span class='glyphicon glyphicon-remove' aria-hidden='true'></span>
</a>
<a class='panel-btn' href='#blob:{{type}}/{{id}}'>
<span class='glyphicon glyphicon-link' aria-hidden='true'></span>
</a>
Blobs for "<b>{{type}}/{{id}}</b>"
</h3>
</div>
<div class='panel-body'>
{{#each data}}
<pre>{{{this}}}</pre>
{{/each}}
</div>
</div>
    </script>
    <script id='t-status' type='text/x-handlebars-template'>
<div id='panel{{uid}}' class='panel panel-default'>
<div class='panel-heading'>
<h3 class='panel-title'>
<a class='panel-btn' onclick='closePanel({{uid}})'>
<span class='glyphicon glyphicon-remove' aria-hidden='true'></span>
</a>
<a class='panel-btn' href='#status'>
<span class='glyphicon glyphicon-link' aria-hidden='true'></span>
</a>
Application status
</h3>
</div>
<div class='panel-body'>
<pre>
<b>Frontend version: {{version}}</b>
<b>Backend version: {{data.version}}</b>
Cache: Size {{data.cache.size}}, H/M: {{data.cache.hit}}/{{data.cache.miss}}
</pre>
<h4>Recent update logs</h4>
{{#each data.logs}}
<pre>{{this}}</pre>
{{/each}}
</div>
</div>
    </script>
    <script id='t-error' type='text/x-handlebars-template'>
<div id='panel{{uid}}' class='panel panel-danger'>
<div class='panel-heading'>
<h3 class='panel-title'>
<a class='panel-btn' onclick='closePanel({{uid}})'>
<span class='glyphicon glyphicon-remove' aria-hidden='true'></span>
</a>
{{src}} error occurred
</h3>
</div>
<div class='panel-body'>
<b>{{msg}}</b><br>
<small>URL: {{url}}</small>
</div>
</div>
    </script>
    <script id='t-help' type='text/x-handlebars-template'>
<div id='panel{{uid}}' class='panel panel-default'>
<div class='panel-heading'>
<h3 class='panel-title'>
<a class='panel-btn' onclick='closePanel({{uid}})'>
<span class='glyphicon glyphicon-remove' aria-hidden='true'></span>
</a>
<a class='panel-btn' href='#help'>
<span class='glyphicon glyphicon-link' aria-hidden='true'></span>
</a>
How to use the thing
</h3>
</div>
<div class='panel-body'>
Basic usage:
<ul>
<li>Enter a query and either hit enter or press 'Go'.</li>
<li>To clear the page hit 'Clr'.</li>
<li>To close a panel hit the 'X' button in its title bar.</li>
<li>To share a direct link to a panel use the link of the 'chain' button in its title bar.</a>
</ul>
"Advanced" features:
<ul>
<li>The query is interpreted as a case-insensitive <a href='http://en.wikipedia.org/wiki/Regexp' target='_blank'>regular expression</a>.</li>
<li>The backend tries to be as agnostic as possible, and you search by whatever was extracted as a unique-ish 'id' key. Blobs without 'type' key are never loaded. See the <a onclick='status()'>status</a> panel.</li>
<li>You can use keyboard too:
<ul>
<li>Right arrow - move to next panel ('down').</li>
<li>Left arrow - move to previous panel ('up').</li>
<li>c - close the 'current' panel.</li>
</ul></li>
</ul>
</div>
</div>
    </script>
    <script>
var backend = 'http://localhost:8112/backend';

var VERSION = '0.8.1';
var counter = 0;
var current = 0;
var t_search = Handlebars.compile($('#t-search').html());
var t_show = Handlebars.compile($('#t-show').html());
var t_status = Handlebars.compile($('#t-status').html());
var t_error = Handlebars.compile($('#t-error').html());
var t_help = Handlebars.compile($('#t-help').html());

function closeAll() {
  $('#outlet').empty();
  counter = 0;
};

function closePanel(uid) {
  $('#panel' + uid).remove();
};

function mkUrl() {
  return backend + '/' + Array.prototype.slice.call(arguments).join('/');
};

function addPanel(data, args) {
  $('#outlet').append(data);
  if (args && args.sortable) {
    $('#table' + counter).tablesorter({sortList: [[0,0]]});
  }
  $('html, body').animate({scrollTop: $('#panel' + counter).offset().top - 64}, 1000);
  current = counter;
  counter++;
}

function selectPanel(offset) {
  if ($('#outlet').children().length == 0) { return; }
  do {
    panel = current + offset;
    if (panel > (counter - 1)) { panel = 0; }
    if (panel < 0) { panel = counter - 1; }
    current = panel;
  } while ($('#panel' + current).length == 0);
  $('html, body').animate({scrollTop: $('#panel' + current).offset().top - 64}, 1000);
};

function request(url, template, args) {
  $.ajax({
    url: url,
    success: function(resp, stat, xhr) {
      if (resp.success) {
        data = template($.extend({uid: counter, data: resp.data}, args));
      } else {
        data = t_error({uid: counter, msg: resp.error, url: url, src: 'Backend'});
      }
      addPanel(data, args);
    },
    error: function(xhr, stat, err) {
      msg = ['All I know:', xhr.statusText, stat, err].join(' ');
      msg += ' - yeah, most likely the backend is unreachable.';
      addPanel(t_error({uid: counter, msg: msg, url: url, src: 'Frontend'}));
    }
  });
};

function search() {
  query = $('#query').val();
  if (query == '') { return };
  request(mkUrl('search', encodeURI(query)), t_search, {query: query, sortable: true});
};

function show(type, id) {
  request(mkUrl('blobs', type, id), t_show, {type: type, id: id});
};

function status() {
  request(mkUrl('status'), t_status, {version: VERSION});
};

function help() {
  addPanel(t_help({uid: counter}));
}

function setup() {
  $('#query').keyup(function(ev) {
    if (ev.which == 13) { search(); }
  });
  $('body').keyup(function(ev) {
    switch (ev.which) {
      case 37: selectPanel(-1); break;
      case 39: selectPanel(1); break;
      case 67: closePanel(current); break;
    }
  });
  
  if (window.location.hash.length > 4) {
    args = window.location.hash.slice(1).split(':');

    switch (args[0]) {
      case 'blob':
        if (args.length == 2) {
          sargs = args[1].split('/');
          if (sargs.length == 2) { show(sargs[0], sargs[1]); };
        }
        break;
      case 'search':
        if (args.length == 2) {
          $('#query').val(args[1]);
          search();
        }
        break;
      case 'status':
        status();
        break;
      case 'help':
        help();
        break;
    }
  };
};
    </script>
  </head>
  <body onload='setup()'>
    <div class='navbar navbar-inverse navbar-fixed-top' role='navigation'>
      <div class='container'>
        <div class='navbar-header'>
          <button class='navbar-toggle' data-target='.navbar-collapse' data-toggle='collapse' type='button'>
            <span class='sr-only'>Toggle navigation</span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
          </button>
          <a class='navbar-brand' href='/'>CDDA RJB</a>
        </div>
        <div class='collapse navbar-collapse'>
          <ul class='nav navbar-nav navbar-right'>
            <li>
              <a href='#status' onclick='status()'>Status</a>
            </li>
            <li>
              <a href='https://github.com/drbig/cddarjb' target='_blank'>About</a>
            </li>
          </ul>
          <div class='navbar-form'>
            <div class='form-group'>
              <div class='input-group'>
                <div class='input-group-addon'>Query</div>
                <input class='form-control' name='query' id='query' type='text' placeholder='Regexp query string'>
              </div>
            </div>
            <button class='btn btn-success' onclick='search()'>Go</button>
            <button class='btn btn-danger' onclick='closeAll()'>Clr</button>
            <button class='btn btn-info' onclick='help()'>?</button>
          </div>
        </div>
      </div>
    </div>
    <div id='outlet' class='container'>
    </div>
    <div class='container'>
      <div class='footer'>
        &copy; Copyright 2015 Piotr S. Staszewski.
      </div>
    </div>
  </body>
</html>
